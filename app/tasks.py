from celery import Celery
from celery import states
from video.text_analyze import TextAnalyze
from speech.recognizer import Recognizer

from services.video_service_factory import VideoServiceFactory

celery_app = Celery("tasks", backend="redis://redis:6379/0", broker="redis://redis:6379/0")

@celery_app.task(bind=True)
def process_article_generation(self, video_url):
    data = []

    self.update_state(state='DOWNLOAD')
    service = VideoServiceFactory.create_service(video_url)
    video_path = service.download_video()
    if service.is_youtube:
        episodes = service.get_episodes()

        self.update_state(state='TRANSCRIBE')
        # recognizer = Recognizer()
        # transcript = recognizer.transcribe(video_path)
        transcript = {'segments': [{'time': 0.0, 'text': ' Добрый день, друзья! На связи пух-эксперт-8 и я его куратер казакового Лариса.'}, {'time': 11.0, 'text': ' Для вас очередной выпуск на востей один из бухгалтерия за 5 минут.'}, {'time': 16.0, 'text': ' Уже полгода мы пытаемся справиться с непослушным YNA-S и, пожалуй, без психологических мер-поддержки уже трудновато.'}, {'time': 26.0, 'text': ' Я, например, занимаюсь йогой, а вы, какие в находите пути для эмоционального равновесия?'}, {'time': 32.0, 'text': ' И я знаю, что с YNA-S будет все хорошо, а чтобы у вас тоже появилась такая уверенность,'}, {'time': 38.0, 'text': ' пройдите наш самучитель проаботе с единым налоговым счетом и единым налоговым платежом.'}, {'time': 44.0, 'text': ' Здесь собрана все. Основные понятия, единого налога у счета, единого налога у платежа, механизм работы в 1С единым налоговым счетом.'}, {'time': 55.0, 'text': ' Особенность и отражения различных налогов на едином налоговом счете и поиска исправления ошибок.'}, {'time': 62.0, 'text': ' В конце тест, вы можете проверить, насколько вы знаете тему.'}, {'time': 67.0, 'text': ' Но для тех, кто хочет углубиться и лучше понимать, а также у кого есть вопросы по единым налоговому счету,'}, {'time': 77.0, 'text': ' приглашаем вас на серию семинаров.'}, {'time': 79.0, 'text': ' Топ, вопросов и ошибок, по уведомлением и операциям на YNA-S.'}, {'time': 84.0, 'text': ' Первый эфир уже прошел 24 мая.'}, {'time': 87.0, 'text': ' За 50 семинара, размещены на сайте.'}, {'time': 90.0, 'text': ' Ссылка на него будет до на в описании.'}, {'time': 93.0, 'text': ' Следующие три эфира пройдут один за другим в течение июня.'}, {'time': 97.0, 'text': ' 20-го топ-вопросов и ошибок по уведомлением, в части зарплатных налогов.'}, {'time': 103.0, 'text': ' 23-го топ-вопросов и ошибок по операциям на YNA-S в части налога на прибыль.'}, {'time': 108.0, 'text': ' И 27-го июня мы разберем вопросы и ошибки, которые не вошли в предыдущие три эфира.'}, {'time': 116.0, 'text': ' Оставьте себе ссылки на эти семинары в своих закладках.'}, {'time': 120.0, 'text': ' А мы двигаемся дальше.'}, {'time': 122.0, 'text': ' Учет затрат на DMS в программе и изменен.'}, {'time': 125.0, 'text': ' Будьте внимательны.'}, {'time': 127.0, 'text': ' Учет затрат на добровольное медицинское страхование в программе.'}, {'time': 131.0, 'text': ' Сейчас изменен.'}, {'time': 133.0, 'text': ' На сайте размещены две статьи.'}, {'time': 135.0, 'text': ' Учет затрат на добровольное медицинское страхование.'}, {'time': 138.0, 'text': ' Работников по несколько договорам и у кого.'}, {'time': 141.0, 'text': ' Только один договор.'}, {'time': 143.0, 'text': ' Учет затрат на добровольное медицинское страхование по одному договору.'}, {'time': 147.0, 'text': ' С релиза 3.035 механизм несколько изменился.'}, {'time': 151.0, 'text': ' Давайте посмотрим, что именно изменилось.'}, {'time': 154.0, 'text': ' Во-первых, поменялась форма расходы будущих периодов.'}, {'time': 158.0, 'text': ' И для расходов на страхование выделено отдельное вкладка.'}, {'time': 162.0, 'text': ' Здесь присутствуют все виды страхования, которые отличаются по нормированию.'}, {'time': 168.0, 'text': ' Долгосрочное страхование жизни, страхование на оплату медицинских расходов,'}, {'time': 173.0, 'text': ' Тобишь DMS, страхование на случай смерти и утраты трудоспособности,'}, {'time': 178.0, 'text': ' а также прочие виды страхования.'}, {'time': 180.0, 'text': ' Кроме того, в алгоритм унесены изменения в части нормирования фунда оплата труда.'}, {'time': 186.0, 'text': ' Теперь срок действия договора очень важный параметр.'}, {'time': 190.0, 'text': ' И его обязательно следует установить.'}, {'time': 193.0, 'text': ' Особенно, если договор действует не с начала месяца,'}, {'time': 197.0, 'text': ' программа учитывает фон топлаты труда как базу для нормирования,'}, {'time': 201.0, 'text': ' с учетом количества дне действия договора в месяце.'}, {'time': 205.0, 'text': ' Следующее изменение справки расчутин.'}, {'time': 210.0, 'text': ' Нормирование расходов, а вернее, в расшифровке предельного размера'},{'time': 215.0, 'text': ' появилась дополнительная справка, которая состоит из нескольких таблиц,'}, {'time': 220.0, 'text': ' где подробно объясняется почему предельный размер расходов на DMS именно такой, а не другой.'}, {'time': 228.0, 'text': ' И в наших статьях подробно разобраны все эти изменения'}, {'time': 233.0, 'text': ' и в частности показаны и описаны, как пользоваться новыми справками'}, {'time': 239.0, 'text': ' для объяснения предельного размера расходов.'}, {'time': 243.0, 'text': ' А мы переходим снова к курсовым разницам,'}, {'time': 246.0, 'text': ' но нет никаких новостей по законодательству нет,'}, {'time': 250.0, 'text': ' просто мы подготовили самоучитель по работе с курсовыми разницами.'}, {'time': 256.0, 'text': ' Учет курсовых разниц в 22 году, несколько изменился, осложился'}, {'time': 262.0, 'text': ' и поэтому вопросов в прошлом году было очень много.'}, {'time': 265.0, 'text': ' Мы подготовили самоучитель по учету курсовых разниц.'}, {'time': 269.0, 'text': ' Здесь также, как и в самоучитель PNES, прежде всего основные понятия,'}, {'time': 275.0, 'text': ' механизм работы с курсовыми разницами до 2022 года'}, {'time': 280.0, 'text': ' и после 2024 года, а также подробнейшим образом,'}, {'time': 285.0, 'text': ' рассмотрены особенности учеток курсовых разниц в период 2022 года.'}, {'time': 292.0, 'text': ' Кроме того, есть большая статья курсовые разницы в 2022-24 годах.'}, {'time': 299.0, 'text': ' Где сквозной пример подробно рассматривает особенности учетов в 2022 году'}, {'time': 306.0, 'text': ' и в 23 году.'}, {'time': 308.0, 'text': ' Механизмы учета в 1,22 и в 23, несколько разный.'}, {'time': 313.0, 'text': ' Данный пример, как раз курсовые разницы начинает начисляться в 2022 году'}, {'time': 319.0, 'text': ' и заканчиваются в 23.'}, {'time': 321.0, 'text': ' В конце вы можете проверить себя, насколько хорошо,'}, {'time': 325.0, 'text': ' вы усвоили материал, насколько хорошо вы разбираетесь в учете курсовых разниц.'}, {'time': 331.0, 'text': ' А еще одно новое статья, NDS, смешциновой разницы, как отразить в 1,'}, {'time': 339.0, 'text': ' с недавных пор у нас появилась автоматизация по начислению NDS,'}, {'time': 344.0, 'text': ' смешциновых разниц.'}, {'time': 346.0, 'text': ' В каких случаях используется Мешциновая разница, как база для начисления NDS?'}, {'time': 353.0, 'text': ' Когда у нас производится реализация имущества учтенного по стоимости,'}, {'time': 358.0, 'text': ' который включает NDS?'}, {'time': 360.0, 'text': ' Например, используемого в необлагаемых индейс операций полученного,'}, {'time': 365.0, 'text': ' безвозмезно или купленного за счет субсидии.'}, {'time': 369.0, 'text': ' Также реализуются товары, сельхоз продукции или продукты ее переработки,'}, {'time': 375.0, 'text': ' если мы их приобрели у физлиц для перепродажи.'}, {'time': 379.0, 'text': ' А также, если мы перепродаем автомобили мотоциклы электронную бытовую технику,'}, {'time': 386.0, 'text': ' которую также купили у физлиц.'}, {'time': 389.0, 'text': ' В этих случаях у нас NDS начисляется смешциновой разницы.'}, {'time': 393.0, 'text': ' И в этом случае нам потребуется настройка функциональности,'}, {'time': 398.0, 'text': ' где появился флаг NDS в смешциновой разницы.'}, {'time': 402.0, 'text': ' И далее идет настройка NDS.'}, {'time': 406.0, 'text': ' Обратите внимание, что стоимость приобретения товара,'}, {'time': 409.0, 'text': ' который мы будем реализовать и облагать NDS в смешциновую разница,'}, {'time': 414.0, 'text': ' должна быть ниже чем цена реализации.'}, {'time': 417.0, 'text': ' Если у вас обратная ситуация и вы продаете товар с убытком,'}, {'time': 422.0, 'text': ' то пути обхода данная статья тоже дает.'}, {'time': 426.0, 'text': ' И еще одна новость для индивидуальных предпринимателей,'}, {'time': 430.0, 'text': ' которые совмещают упрощенную систему налога обложения и потент.'}, {'time': 435.0, 'text': ' Такой вопрос – индивидуальный предприниматель совмещающий у CN и PCN без работников.'}, {'time': 441.0, 'text':' Фиксированные страховые взносы за четвертый квартал были учитены при расчете у CN'}, {'time': 446.0, 'text': ' куплати за 22 ку.'}, {'time': 448.0, 'text': ' После перепроведения закрытия месяца, страховые взносы пересчитались,'}, {'time': 454.0, 'text': ' перестали распределяться между у CN и PCN и сумма налога исказилась.'}, {'time': 460.0, 'text': ' Это ошибка, которая была зарегистрирована и оперативно выпущен пачь.'}, {'time': 467.0, 'text': ' Его можно скачать для версии 3.037.39,'}, {'time': 473.0, 'text': ' но в пятницу 16 и ее не вышло также обновление программы 3.038.24,'}, {'time': 481.0, 'text': ' где, скорее всего, эта ошибка уже исправлена.'}, {'time': 485.0, 'text': ' Не забывайте подписываться на наш канал, жмите на колокольчик'}, {'time': 491.0, 'text': ' и вы всегда будете в курсе наших новостей.'}, {'time': 494.0, 'text': ' Подписывайтесь на наш телеграм канал, ссылка на него будет до на внизу под видео.'}, {'time': 499.0, 'text': ' А я с вами прощаюсь. До новых встреч!'}, {'time': 515.0, 'text': ' До свидания!'}]}

        self.update_state(state='ANALYZE')
        text_analyze = TextAnalyze()
        data = text_analyze.analyze_episodes(video_path, transcript, episodes)
        data = {"url": video_url, "data": data}
    
    return data